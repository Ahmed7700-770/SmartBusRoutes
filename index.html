<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام مسارات الباصات المدرسية المتقدم - الذكاء الاصطناعي</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin=""/>
  
  <!-- SheetJS لتصدير Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <!-- Font Awesome للأيقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* ====== تصميم حديث بمظهر الزجاج والوضع الداكن ====== */
    :root {
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-stroke: rgba(255, 255, 255, 0.2);
      --primary: #60a5fa;
      --primary-dark: #3b82f6;
      --primary-light: #93c5fd;
      --secondary: #a78bfa;
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f87171;
      --info: #22d3ee;
      --ai-color: #a78bfa;
      --text: #f8fafc;
      --muted: #cbd5e1;
      --light: rgba(30, 41, 59, 0.5);
      --border: rgba(255, 255, 255, 0.1);
      --shadow: rgba(0, 0, 0, 0.3);
      --radius: 16px;
      --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }

    .light-mode {
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-stroke: rgba(15, 23, 42, 0.1);
      --primary: #3b82f6;
      --primary-dark: #1d4ed8;
      --primary-light: #93c5fd;
      --secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --ai-color: #8b5cf6;
      --text: #1e293b;
      --muted: #64748b;
      --light: #f8fafc;
      --border: #e2e8f0;
      --shadow: rgba(2, 6, 23, 0.1);
      --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Tajawal', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      transition: all 0.3s ease;
    }

    #app {
      display: grid;
      grid-template-columns: 480px 1fr;
      height: 100%;
      gap: 16px;
      padding: 16px;
    }

    #side {
      padding: 20px;
      overflow: auto;
      background: var(--glass-bg);
      border: 1px solid var(--glass-stroke);
      backdrop-filter: saturate(180%) blur(12px);
      border-radius: var(--radius);
      box-shadow: 0 12px 32px var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #map {
      height: 100%;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: 0 16px 40px var(--shadow);
      z-index: 1;
      position: relative;
    }

    .map-container {
      width: 100%;
      height: 100%;
      border-radius: var(--radius);
      overflow: hidden;
    }

    .map-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      z-index: 0;
    }

    .map-placeholder.hidden {
      display: none;
    }

    .map-loading {
      text-align: center;
      padding: 20px;
    }

    .map-error {
      text-align: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      margin: 20px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: var(--radius);
      color: white;
      margin-bottom: 8px;
    }

    .logo {
      font-weight: 900;
      font-size: 18px;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      background: var(--glass-bg);
      backdrop-filter: saturate(180%) blur(10px);
      box-shadow: 0 4px 12px var(--shadow);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 8px 24px var(--shadow);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      cursor: pointer;
      user-select: none;
    }

    .card-title {
      font-weight: 800;
      font-size: 16px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      font-size: 14px;
      background: var(--primary-light);
      color: var(--primary-dark);
    }

    .card-icon.ai {
      background: var(--ai-color);
      color: white;
    }

    .card-content {
      margin-top: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    input, textarea, select, button {
      font-size: 14px;
      font-family: inherit;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
      background: var(--light);
      color: var(--text);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input::placeholder, textarea::placeholder {
      color: var(--muted);
    }

    button {
      padding: 12px 18px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      box-shadow: 0 8px 18px rgba(59, 130, 246, 0.25);
      transition: all 0.2s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      box-shadow: 0 10px 24px rgba(59, 130, 246, 0.35);
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-secondary {
      background: var(--secondary);
      box-shadow: 0 8px 18px rgba(139, 92, 246, 0.25);
    }

    .btn-secondary:hover {
      box-shadow: 0 10px 24px rgba(139, 92, 246, 0.35);
    }

    .btn-success {
      background: var(--success);
      box-shadow: 0 8px 18px rgba(16, 185, 129, 0.25);
    }

    .btn-success:hover {
      box-shadow: 0 10px 24px rgba(16, 185, 129, 0.35);
    }

    .btn-warning {
      background: var(--warning);
      box-shadow: 0 8px 18px rgba(245, 158, 11, 0.25);
    }

    .btn-warning:hover {
      box-shadow: 0 10px 24px rgba(245, 158, 11, 0.35);
    }

    .btn-danger {
      background: var(--danger);
      box-shadow: 0 8px 18px rgba(239, 68, 68, 0.25);
    }

    .btn-danger:hover {
      box-shadow: 0 10px 24px rgba(239, 68, 68, 0.35);
    }

    .btn-ai {
      background: var(--ai-color);
      box-shadow: 0 8px 18px rgba(139, 92, 246, 0.25);
    }

    .btn-ai:hover {
      box-shadow: 0 10px 24px rgba(139, 92, 246, 0.35);
    }

    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: 0 4px 10px rgba(2, 6, 23, 0.06);
    }

    .btn-outline:hover {
      background: var(--light);
      box-shadow: 0 6px 14px rgba(2, 6, 23, 0.1);
    }

    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .flex-1 {
      flex: 1;
    }

    .list {
      border: 1px dashed var(--border);
      padding: 12px;
      border-radius: 12px;
      max-height: 200px;
      overflow: auto;
      background: var(--light);
    }

    .list-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.15s ease;
    }

    .list-item:hover {
      background: var(--glass-bg);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .student-name {
      cursor: pointer;
      color: var(--primary);
      font-weight: 700;
      transition: color 0.2s ease;
    }

    .student-name:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.5;
    }

    .toast {
      position: fixed;
      left: 24px;
      bottom: 24px;
      background: var(--primary);
      color: white;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid var(--primary-light);
      box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3);
      display: none;
      font-weight: 700;
      font-size: 14px;
      z-index: 10000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* تخصيص الخريطة */
    .leaflet-container {
      font-family: 'Tajawal', sans-serif;
      border-radius: var(--radius);
    }

    .leaflet-popup-content {
      margin: 16px;
      font-family: 'Tajawal', sans-serif;
      color: #1e293b;
    }

    .leaflet-tooltip {
      font-family: 'Tajawal', sans-serif;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
    }

    .map-label {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: saturate(180%) blur(8px);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 16px;
      font-weight: 800;
      font-size: 13px;
      color: var(--text);
      box-shadow: 0 8px 20px rgba(2, 6, 23, 0.12);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .label-school {
      border-color: var(--primary-light);
    }

    .label-supervisor {
      border-color: #d8b4fe;
    }

    .label-student {
      border-color: #a7f3d0;
    }

    .icon-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .school-dot {
      background: var(--primary);
    }

    .supervisor-dot {
      background: var(--secondary);
    }

    .student-dot {
      background: var(--success);
    }

    /* أيقونات مخصصة للخريطة */
    .custom-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .school-marker {
      background: var(--primary);
      color: white;
      width: 40px;
      height: 40px;
      font-size: 18px;
    }

    .supervisor-marker {
      background: var(--secondary);
      color: white;
      width: 36px;
      height: 36px;
      font-size: 16px;
    }

    .student-marker {
      background: var(--success);
      color: white;
      width: 32px;
      height: 32px;
      font-size: 14px;
      font-weight: bold;
    }

    /* راديو اختيار نوع المسار */
    .route-type-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .route-type-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: var(--light);
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      transition: all 0.2s ease;
      text-align: center;
    }

    .route-type-btn:hover {
      border-color: var(--muted);
      background: var(--glass-bg);
    }

    .route-type-btn.active {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
    }

    .route-type-btn .subtitle {
      font-size: 11px;
      font-weight: 400;
      margin-top: 4px;
      color: var(--muted);
    }

    /* ملخص المسارات */
    .summary-box {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.6;
      font-family: 'Courier New', monospace;
      color: var(--text);
    }

    .ai-suggestions {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      font-size: 13px;
      line-height: 1.6;
      border-left: 4px solid var(--ai-color);
    }

    .ai-suggestions h4 {
      color: var(--ai-color);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* تحسينات للشريط الجانبي */
    .side-section {
      margin-bottom: 20px;
    }

    /* تحسينات التمرير */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* تصميم متجاوب */
    @media (max-width: 1024px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      
      #side {
        max-height: 40vh;
        overflow-y: auto;
      }
    }

    .api-key-input {
      position: relative;
    }

    .api-key-input input {
      padding-right: 40px;
    }

    .toggle-visibility {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
    }
    
    .progress-container {
      margin-top: 16px;
      background: var(--light);
      border-radius: 12px;
      height: 8px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .route-links {
      margin-top: 16px;
    }
    
    .route-link {
      display: block;
      padding: 10px 12px;
      background: var(--light);
      border-radius: 8px;
      margin-bottom: 8px;
      text-decoration: none;
      color: var(--text);
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    
    .route-link:hover {
      background: var(--glass-bg);
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow);
    }
    
    .route-link-title {
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    
    .route-link-details {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
    }
    
    .student-list-route {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .student-route-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .student-route-item:hover {
      background: var(--glass-bg);
    }
    
    .student-route-item:last-child {
      border-bottom: none;
    }
    
    .student-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }
    
    .student-info {
      flex: 1;
    }
    
    .student-name-route {
      font-weight: 600;
      color: var(--text);
    }
    
    .student-location {
      font-size: 11px;
      color: var(--muted);
    }
    
    .evening-indicator {
      background: var(--secondary);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      margin-right: 8px;
    }
    
    /* تحكم في الوضع */
    .theme-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: var(--glass-bg);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px var(--shadow);
      transition: all 0.3s ease;
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
    }
    
    /* تصميم الباص المتحرك */
    .bus-marker {
      background: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      border: 2px solid white;
    }
    
    .bus-icon {
      color: #1e293b;
      font-size: 12px;
    }
    
    .animation-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      background: var(--glass-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px var(--shadow);
    }
    
    .animation-btn {
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .animation-btn:hover {
      background: var(--primary-dark);
    }
    
    .animation-btn:disabled {
      background: var(--muted);
      cursor: not-allowed;
    }
    
    /* تحسينات السحب والإفلات */
    .draggable-list {
      min-height: 100px;
    }
    
    .student-route-item.dragging {
      opacity: 0.5;
      background: var(--primary-light);
    }
    
    .student-route-item.drag-over {
      border-top: 2px solid var(--primary);
    }
    
    .edit-order-btn {
      background: var(--info);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .edit-order-btn:hover {
      background: var(--info);
      opacity: 0.9;
    }
    
    .google-maps-link {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--primary);
      text-decoration: none;
      font-size: 12px;
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      transition: all 0.2s ease;
      text-align: center;
      justify-content: center;
    }
    
    .google-maps-link:hover {
      background: rgba(59, 130, 246, 0.2);
      text-decoration: none;
      transform: translateY(-1px);
    }
    
    .route-optimization-info {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 211, 238, 0.1));
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      font-size: 12px;
      line-height: 1.5;
    }
    
    .route-optimization-info h5 {
      color: var(--success);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .route-link-info {
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .warning-text {
      color: var(--warning);
      font-size: 10px;
    }
  </style>
</head>
<body>
<!-- زر تبديل الوضع -->
<div class="theme-toggle" id="themeToggle">
  <i class="fas fa-moon" id="themeIcon"></i>
</div>

<!-- عناصر تحكم الرسوم المتحركة -->
<div class="animation-controls" id="animationControls" style="display: none;">
  <button class="animation-btn" id="playAnimation">
    <i class="fas fa-play"></i> تشغيل
  </button>
  <button class="animation-btn" id="pauseAnimation">
    <i class="fas fa-pause"></i> إيقاف
  </button>
  <button class="animation-btn" id="resetAnimation">
    <i class="fas fa-redo"></i> إعادة
  </button>
</div>

<div id="app">
  <div id="side">
    <!-- محتوى الشريط الجانبي -->
    <div class="header">
      <div class="logo">
        <i class="fas fa-robot"></i>
        نظام المسارات - الذكاء الاصطناعي
      </div>
      <div class="badge">AI Powered</div>
    </div>

    <!-- إعدادات الذكاء الاصطناعي -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-title">
          <div class="card-icon ai">
            <i class="fas fa-key"></i>
          </div>
          إعدادات الذكاء الاصطناعي
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label>مفتاح OpenAI API</label>
          <div class="api-key-input">
            <input type="password" id="apiKey" placeholder="sk-..." />
            <button type="button" class="toggle-visibility" onclick="toggleApiKeyVisibility()">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="hint">
            أدخل مفتاح OpenAI API لتفعيل الذكاء الاصطناعي. 
            <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--primary);">الحصول على مفتاح</a>
          </div>
        </div>
        <div class="form-group">
          <label>نموذج الذكاء الاصطناعي</label>
          <select id="aiModel">
            <option value="gpt-3.5-turbo">GPT-3.5 Turbo (سريع واقتصادي)</option>
            <option value="gpt-4">GPT-4 (أكثر ذكاءً ودقة)</option>
            <option value="gpt-4-turbo">GPT-4 Turbo (الأحدث)</option>
          </select>
        </div>
        <button id="testAi" class="btn-outline">
          <i class="fas fa-test"></i>
          اختبار الاتصال
        </button>
      </div>
    </div>

    <!-- حفظ وتحميل الخطط -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-save"></i>
          </div>
          إدارة الخطط
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="card-content">
        <div class="row">
          <button id="savePlan" class="btn-success">
            <i class="fas fa-download"></i>
            حفظ الخطة
          </button>
          <div class="file-input-wrapper flex-1">
            <input type="file" id="loadPlanInput" accept=".json" />
            <label for="loadPlanInput" class="btn-outline" style="text-align: center; display: block; cursor: pointer;">
              <i class="fas fa-upload"></i>
              تحميل خطة
            </label>
          </div>
        </div>
        <div class="hint">احفظ جميع الإعدادات الحالية في ملف JSON يمكنك تحميله لاحقًا</div>
      </div>
    </div>

    <!-- المدرسة والمشرف -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-school"></i>
          </div>
          المدرسة والمشرف
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label>موقع المدرسة</label>
          <input id="school" placeholder="رابط خرائط جوجل أو إحداثيات (lat, lon)" value="25.285, 51.531" />
          <div class="hint">مثال: https://maps.google.com/?q=25.285,51.531 أو 25.285, 51.531</div>
        </div>
        <div class="form-group">
          <label>موقع المشرف (نقطة البداية/النهاية)</label>
          <input id="supervisor" placeholder="رابط خرائط جوجل أو إحداثيات (lat, lon)" value="25.300, 51.500" />
          <div class="hint">يمكن استخدامه كنقطة انطلاق أو نقطة نهاية حسب نوع المسار</div>
        </div>
        <div class="row">
          <button id="setMarkersBtn" class="btn-outline">
            <i class="fas fa-map-marker-alt"></i>
            تثبيت المواقع
          </button>
          <button id="useMapBtn" class="btn-outline">
            <i class="fas fa-map"></i>
            التقاط من الخريطة
          </button>
        </div>
        <div class="hint">يمكنك سحب العلامات على الخريطة مباشرة لتحديث المواقع</div>
      </div>
    </div>

    <!-- الطلاب -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-users"></i>
          </div>
          الطلاب
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="card-content">
        <div class="row">
          <div class="flex-1">
            <label>الموقع</label>
            <input id="stuLocation" placeholder="رابط خرائط جوجل أو lat, lon" />
          </div>
        </div>
        <div class="form-group">
          <label>اسم الطالب (اختياري)</label>
          <input id="stuName" placeholder="أدخل اسم الطالب" />
        </div>
        <div class="row">
          <button id="addStudent" class="btn-success">
            <i class="fas fa-plus"></i>
            إضافة طالب
          </button>
          <button id="clearStudents" class="btn-danger">
            <i class="fas fa-trash"></i>
            مسح الكل
          </button>
        </div>
        <div class="hint">أو ألصق قائمة (سطر لكل طالب: خط العرض , خط الطول , الاسم)</div>
        <textarea id="bulk" rows="4" placeholder="25.115868 , 51.540138,نجلا علي&#10;25.36,51.47,محمد أحمد&#10;25.37,51.49,فاطمة"></textarea>
        <div style="margin-top: 8px;">
          <button id="addBulk" class="btn-outline">
            <i class="fas fa-list"></i>
            إضافة بالجملة
          </button>
          <button id="openConverterBtn" class="btn-outline">
            <i class="fas fa-exchange-alt"></i>
            فتح محول الإحداثيات
          </button>
        </div>
        <div class="list" id="studentsList" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- الباصات -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-bus-alt"></i>
          </div>
          إعدادات الباصات
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label>سعات الباصات (مفصولة بفواصل)</label>
          <input id="busSizes" placeholder="39,39,35,28,12" value="39,39,35" />
          <div class="hint">سيتم توزيع الطلاب تلقائيًا على الباصات المتاحة بناءً على السعة والموقع</div>
        </div>
        <div class="form-group">
          <label>خوارزمية التوزيع</label>
          <select id="algorithm">
            <option value="nearest">الأقرب أولاً (مثالي للمسافات القصيرة)</option>
            <option value="kmeans">K-Means (حسب التجمعات الجغرافية)</option>
            <option value="balanced">متوازن (حسب السعة والموقع)</option>
          </select>
        </div>
        <div class="route-optimization-info">
          <h5><i class="fas fa-route"></i> معلومات التحسين</h5>
          <div>الخوارزمية المحسنة تضمن أقصر مسار ممكن باستخدام حسابات المسافات الحقيقية بين النقاط.</div>
        </div>
      </div>
    </div>

    <!-- خيارات المسار -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-route"></i>
          </div>
          خيارات المسار
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label>نوع المسار المطلوب</label>
          <div class="route-type-selector">
            <div class="route-type-btn active" data-type="both">
              <div>كلا المسارين</div>
              <div class="subtitle">صباحي + مسائي</div>
            </div>
            <div class="route-type-btn" data-type="morning">
              <div>صباحي فقط</div>
              <div class="subtitle">من المشرف → المدرسة</div>
            </div>
            <div class="route-type-btn" data-type="evening">
              <div>مسائي فقط</div>
              <div class="subtitle">من المدرسة → المشرف</div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>مزود التوجيه</label>
          <select id="apiProvider">
            <option value="osrm">OSRM (افتراضي - مجاني)</option>
            <option value="ors">OpenRouteService (بديل)</option>
          </select>
        </div>
        <div class="form-group">
          <label>إعدادات المسائي</label>
          <div class="hint">
            <input type="checkbox" id="eveningLastStudent" checked />
            <label for="eveningLastStudent" style="display: inline; font-weight: normal;">إضافة خانة مسائي لآخر طالب</label>
          </div>
        </div>
        <div class="hint">المسار الصباحي يبدأ من المشرف ويمر بالطلاب وينتهي بالمدرسة. المسار المسائي يبدأ من المدرسة ويمر بالطلاب وينتهي بالمشرف.</div>
      </div>
    </div>

    <!-- تنفيذ الخطة -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-play"></i>
          </div>
          تنفيذ وتصدير
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="card-content">
        <div class="progress-container" style="display: none;" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <button id="run" class="btn-warning" style="width: 100%; margin-bottom: 16px;">
          <span id="runText">
            <i class="fas fa-rocket"></i>
            توليد المسارات الحقيقية
          </span>
        </button>
        
        <button id="runWithAI" class="btn-ai" style="width: 100%; margin-bottom: 16px;">
          <span id="runAiText">
            <i class="fas fa-robot"></i>
            توليد المسارات بالذكاء الاصطناعي
          </span>
        </button>
        
        <div class="row">
          <button id="exportCsv" class="btn-outline">
            <i class="fas fa-file-csv"></i>
            تصدير CSV
          </button>
          <button id="exportXlsx" class="btn-outline">
            <i class="fas fa-file-excel"></i>
            تصدير Excel
          </button>
        </div>
        <div id="summary" class="summary-box" style="display: none;"></div>
        <div id="aiSuggestions" class="ai-suggestions" style="display: none;"></div>
      </div>
    </div>

    <!-- روابط المسارات -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-link"></i>
          </div>
          روابط المسارات
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="card-content">
        <div id="routeLinks" class="route-links"></div>
      </div>
    </div>

    <!-- قائمة الطلاب حسب المسارات -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)">
        <div class="card-title">
          <div class="card-icon">
            <i class="fas fa-list-ol"></i>
          </div>
          قائمة الطلاب حسب المسارات
        </div>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="card-content">
        <div id="studentsByRoute" class="student-list-route"></div>
      </div>
    </div>
  </div>

  <div id="map">
    <div class="map-container" id="mapContainer"></div>
    <div class="map-placeholder" id="mapPlaceholder">
      <div class="map-loading">
        <i class="fas fa-map-marked-alt" style="font-size: 64px; margin-bottom: 20px;"></i>
        <h2>جاري تحميل الخريطة</h2>
        <p>يرجى الانتظار...</p>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script>
// ==================== المتغيرات العامة ====================
let map;
let schoolMarker;
let supervisorMarker;
let studentMarkers = [];
let routeLayers = [];
let students = [];
let lastRoutes = [];
let currentDisplayedStudents = [];
let busAnimations = [];
let isAnimating = false;
let animationIntervals = [];

// ==================== متغيرات الذكاء الاصطناعي ====================
let openAIApiKey = '';
let aiModel = 'gpt-3.5-turbo';
let isAIEnabled = false;

// ==================== تهيئة التطبيق ====================
document.addEventListener('DOMContentLoaded', function() {
  // تهيئة جميع المكونات
  initApp();
});

function initApp() {
  // تهيئة الخريطة
  initMap();
  
  // ربط الأحداث
  bindEvents();
  
  // تحميل البيانات الأولية
  loadInitialData();
  
  // عرض الطلاب
  renderStudentMarkers();
}

// ==================== وظائف الخريطة ====================
function initMap() {
  try {
    // استخدام خريطة OpenStreetMap
    map = L.map('mapContainer', {
      preferCanvas: true
    }).setView([25.285, 51.531], 12);
    
    // إضافة طبقة الخريطة الأساسية
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 18
    }).addTo(map);
    
    // إخفاء رسالة التحميل بعد تحميل الخريطة
    map.whenReady(function() {
      document.getElementById('mapPlaceholder').classList.add('hidden');
      console.log("تم تحميل الخريطة بنجاح");
    });
    
    // إضافة علامات المدرسة والمشرف
    addSchoolAndSupervisorMarkers();
    
    // إضافة الطلاب الافتراضيين
    addDefaultStudents();
    
  } catch (error) {
    console.error("خطأ في تحميل الخريطة:", error);
    showMapError();
  }
}

function showMapError() {
  const placeholder = document.getElementById('mapPlaceholder');
  placeholder.innerHTML = `
    <div class="map-error">
      <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f59e0b; margin-bottom: 16px;"></i>
      <h3>تعذر تحميل الخريطة</h3>
      <p>هناك مشكلة في اتصال الإنترنت أو في تحميل بيانات الخريطة.</p>
      <button onclick="retryMapLoad()" style="background: #3b82f6; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 16px;">
        <i class="fas fa-redo"></i> إعادة المحاولة
      </button>
    </div>
  `;
}

function retryMapLoad() {
  // إعادة تحميل الصفحة
  location.reload();
}

function addSchoolAndSupervisorMarkers() {
  // إضافة علامة المدرسة
  const schoolCoords = parseCoordinates(document.getElementById('school').value);
  schoolMarker = L.marker(schoolCoords, {
    draggable: true,
    icon: L.divIcon({
      className: 'custom-marker school-marker',
      html: '<i class="fas fa-school"></i>',
      iconSize: [40, 40]
    })
  }).addTo(map);
  
  schoolMarker.bindPopup(`
    <div style="text-align: center; padding: 8px;">
      <h3 style="margin: 0 0 8px 0; color: #1e293b;">المدرسة</h3>
      <p style="margin: 0; color: #64748b;">الموقع الرئيسي للمدرسة</p>
      <p style="margin: 8px 0 0 0; font-size: 12px; color: #94a3b8;">
        ${schoolCoords[0].toFixed(6)}, ${schoolCoords[1].toFixed(6)}
      </p>
    </div>
  `);
  
  // إضافة علامة المشرف
  const supervisorCoords = parseCoordinates(document.getElementById('supervisor').value);
  supervisorMarker = L.marker(supervisorCoords, {
    draggable: true,
    icon: L.divIcon({
      className: 'custom-marker supervisor-marker',
      html: '<i class="fas fa-user-tie"></i>',
      iconSize: [36, 36]
    })
  }).addTo(map);
  
  supervisorMarker.bindPopup(`
    <div style="text-align: center; padding: 8px;">
      <h3 style="margin: 0 0 8px 0; color: #1e293b;">المشرف</h3>
      <p style="margin: 0; color: #64748b;">نقطة البداية/النهاية</p>
      <p style="margin: 8px 0 0 0; font-size: 12px; color: #94a3b8;">
        ${supervisorCoords[0].toFixed(6)}, ${supervisorCoords[1].toFixed(6)}
      </p>
    </div>
  `);
  
  // تحديث الحقول عند سحب العلامات
  schoolMarker.on('dragend', function() {
    const latLng = schoolMarker.getLatLng();
    document.getElementById('school').value = `${latLng.lat.toFixed(6)}, ${latLng.lng.toFixed(6)}`;
  });
  
  supervisorMarker.on('dragend', function() {
    const latLng = supervisorMarker.getLatLng();
    document.getElementById('supervisor').value = `${latLng.lat.toFixed(6)}, ${latLng.lng.toFixed(6)}`;
  });
}

function addDefaultStudents() {
  // إضافة طلاب افتراضيين للاختبار
  const defaultStudents = [
    { name: 'نجلا علي', lat: 25.115868, lng: 51.540138 },
    { name: 'محمد أحمد', lat: 25.36, lng: 51.47 },
    { name: 'فاطمة', lat: 25.37, lng: 51.49 }
  ];
  
  students = defaultStudents;
  renderStudentMarkers();
  updateStudentsList();
}

function renderStudentMarkers() {
  // إزالة العلامات القديمة
  studentMarkers.forEach(marker => map.removeLayer(marker));
  studentMarkers = [];
  
  // إضافة علامات جديدة للطلاب
  students.forEach((student, index) => {
    const marker = L.marker([student.lat, student.lng], {
      draggable: true,
      icon: L.divIcon({
        className: 'custom-marker student-marker',
        html: `<span>${index + 1}</span>`,
        iconSize: [32, 32]
      })
    }).addTo(map);
    
    marker.bindPopup(`
      <div style="text-align: center; padding: 8px; min-width: 200px;">
        <h3 style="margin: 0 0 8px 0; color: #1e293b;">${student.name || 'طالب'}</h3>
        <p style="margin: 0; color: #64748b;">موقع الطالب</p>
        <p style="margin: 8px 0 0 0; font-size: 12px; color: #94a3b8;">
          ${student.lat.toFixed(6)}, ${student.lng.toFixed(6)}
        </p>
        <div style="margin-top: 12px; display: flex; gap: 8px;">
          <button onclick="centerOnStudent(${index})" style="flex: 1; padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
            التركيز
          </button>
          <button onclick="removeStudent(${index})" style="flex: 1; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
            حذف
          </button>
        </div>
      </div>
    `);
    
    // تحديث موقع الطالب عند السحب
    marker.on('dragend', function() {
      const latLng = marker.getLatLng();
      students[index].lat = latLng.lat;
      students[index].lng = latLng.lng;
      updateStudentsList();
    });
    
    studentMarkers.push(marker);
  });
}

// ==================== وظائف إدارة البيانات ====================
function parseCoordinates(input) {
  if (!input) return [25.285, 51.531]; // إحداثيات افتراضية
  
  // محاولة استخراج الإحداثيات من رابط خرائط جوجل
  const googleMapsMatch = input.match(/q=([\d.-]+),([\d.-]+)/);
  if (googleMapsMatch) {
    return [parseFloat(googleMapsMatch[1]), parseFloat(googleMapsMatch[2])];
  }
  
  // محاولة استخراج الإحداثيات من نص عادي
  const coordsMatch = input.match(/([\d.-]+)\s*,\s*([\d.-]+)/);
  if (coordsMatch) {
    return [parseFloat(coordsMatch[1]), parseFloat(coordsMatch[2])];
  }
  
  // إذا فشل كل شيء، استخدام الإحداثيات الافتراضية
  return [25.285, 51.531];
}

function setMarkersFromInput() {
  const schoolCoords = parseCoordinates(document.getElementById('school').value);
  const supervisorCoords = parseCoordinates(document.getElementById('supervisor').value);
  
  // تحديث مواقع العلامات
  schoolMarker.setLatLng(schoolCoords);
  supervisorMarker.setLatLng(supervisorCoords);
  
  // تحديث الخريطة للتركيز على المواقع الجديدة
  const group = new L.featureGroup([schoolMarker, supervisorMarker]);
  map.fitBounds(group.getBounds().pad(0.1));
  
  toast('تم تحديث مواقع المدرسة والمشرف');
}

function useMapMarkers() {
  // استخدام المواقع الحالية من الخريطة للحقول
  const schoolLatLng = schoolMarker.getLatLng();
  const supervisorLatLng = supervisorMarker.getLatLng();
  
  document.getElementById('school').value = `${schoolLatLng.lat.toFixed(6)}, ${schoolLatLng.lng.toFixed(6)}`;
  document.getElementById('supervisor').value = `${supervisorLatLng.lat.toFixed(6)}, ${supervisorLatLng.lng.toFixed(6)}`;
  
  toast('تم نسخ المواقع من الخريطة');
}

function addStudent() {
  const location = document.getElementById('stuLocation').value.trim();
  const name = document.getElementById('stuName').value.trim() || `طالب ${students.length + 1}`;
  
  if (!location) {
    alert('الرجاء إدخال موقع الطالب');
    return;
  }
  
  const coords = parseCoordinates(location);
  students.push({
    name: name,
    lat: coords[0],
    lng: coords[1]
  });
  
  // إعادة رسم العلامات وتحديث القائمة
  renderStudentMarkers();
  updateStudentsList();
  
  // مسح الحقول
  document.getElementById('stuLocation').value = '';
  document.getElementById('stuName').value = '';
  
  toast(`تم إضافة الطالب ${name}`);
}

function clearStudents() {
  if (students.length === 0 || confirm(`هل تريد حذف جميع الطلاب (${students.length} طالب)؟`)) {
    students = [];
    renderStudentMarkers();
    updateStudentsList();
    toast('تم حذف جميع الطلاب');
  }
}

function addBulkStudents() {
  const bulkText = document.getElementById('bulk').value.trim();
  if (!bulkText) {
    alert('الرجاء إدخال بيانات الطلاب');
    return;
  }
  
  const lines = bulkText.split('\n');
  let addedCount = 0;
  
  lines.forEach(line => {
    const parts = line.split(',').map(part => part.trim());
    if (parts.length >= 2) {
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      const name = parts[2] || `طالب ${students.length + 1}`;
      
      if (!isNaN(lat) && !isNaN(lng)) {
        students.push({ name, lat, lng });
        addedCount++;
      }
    }
  });
  
  if (addedCount > 0) {
    renderStudentMarkers();
    updateStudentsList();
    toast(`تم إضافة ${addedCount} طالب`);
  } else {
    alert('لم يتم إضافة أي طالب. تأكد من صيغة البيانات');
  }
}

function updateStudentsList() {
  const list = document.getElementById('studentsList');
  list.innerHTML = '';
  
  if (students.length === 0) {
    list.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">لا توجد طلاب مضافة</div>';
    return;
  }
  
  students.forEach((student, index) => {
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <span class="student-name" onclick="centerOnStudent(${index})">${student.name}</span>
      <button class="btn-outline" style="padding: 4px 8px; font-size: 12px;" onclick="removeStudent(${index})">
        <i class="fas fa-times"></i>
      </button>
    `;
    list.appendChild(item);
  });
}

function centerOnStudent(index) {
  if (studentMarkers[index]) {
    map.setView([students[index].lat, students[index].lng], 15);
    studentMarkers[index].openPopup();
  }
}

function removeStudent(index) {
  if (confirm(`هل تريد حذف الطالب ${students[index].name}؟`)) {
    students.splice(index, 1);
    renderStudentMarkers();
    updateStudentsList();
    toast('تم حذف الطالب');
  }
}

// ==================== وظائف محول الإحداثيات ====================
function openCoordinateConverter() {
  // فتح صفحة محول الإحداثيات في نافذة جديدة
  window.open('coordinate_converter.html', '_blank', 'width=1000,height=800,scrollbars=yes,resizable=yes');
}

// ==================== وظائف حساب المسافات ====================
function calculateDistance(lat1, lng1, lat2, lng2) {
  // حساب المسافة بين نقطتين باستخدام صيغة هافرساين (Haversine)
  const R = 6371; // نصف قطر الأرض بالكيلومترات
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
    Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // المسافة بالكيلومترات
}

// ==================== وظائف توليد المسارات الحقيقية ====================
async function generateRoutes() {
  try {
    // إظهار شريط التقدم
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    
    // تعطيل الزر أثناء المعالجة
    const runButton = document.getElementById('run');
    const originalText = runButton.innerHTML;
    runButton.disabled = true;
    runButton.innerHTML = '<span><i class="fas fa-spinner loading"></i> جاري إنشاء المسارات...</span>';
    
    // إخفاء التحكم في الرسوم المتحركة إذا كان ظاهراً
    document.getElementById('animationControls').style.display = 'none';
    
    // مسح المسارات القديمة
    clearRoutes();
    
    // الحصول على إعدادات الباصات
    const busSizes = document.getElementById('busSizes').value.split(',').map(size => parseInt(size.trim()));
    const algorithm = document.getElementById('algorithm').value;
    const routeType = window.selectedRouteType || 'both';
    
    // تحديث شريط التقدم
    progressBar.style.width = '20%';
    
    // توزيع الطلاب على الباصات
    const busAssignments = distributeStudentsToBuses(students, busSizes, algorithm);
    
    // تحديث شريط التقدم
    progressBar.style.width = '40%';
    
    // إنشاء المسارات لكل باص
    const allRoutes = [];
    
    for (let i = 0; i < busAssignments.length; i++) {
      const busStudents = busAssignments[i];
      
      // إنشاء مسار الصباح (من المشرف إلى المدرسة عبر الطلاب)
      if (routeType === 'both' || routeType === 'morning') {
        const morningRoute = await createRouteForBus(busStudents, 'morning', i);
        if (morningRoute) {
          allRoutes.push(morningRoute);
        }
      }
      
      // إنشاء مسار المساء (من المدرسة إلى المشرف عبر الطلاب)
      if (routeType === 'both' || routeType === 'evening') {
        const eveningRoute = await createRouteForBus(busStudents, 'evening', i);
        if (eveningRoute) {
          allRoutes.push(eveningRoute);
        }
      }
      
      // تحديث شريط التقدم
      progressBar.style.width = `${40 + (i / busAssignments.length) * 40}%`;
    }
    
    // تحديث شريط التقدم
    progressBar.style.width = '90%';
    
    // عرض المسارات على الخريطة
    displayRoutes(allRoutes);
    
    // تحديث شريط التقدم
    progressBar.style.width = '100%';
    
    // إظهار التحكم في الرسوم المتحركة
    document.getElementById('animationControls').style.display = 'flex';
    
    // إعادة تعيين الزر
    runButton.disabled = false;
    runButton.innerHTML = originalText;
    
    // إخفاء شريط التقدم بعد ثانية
    setTimeout(() => {
      progressContainer.style.display = 'none';
    }, 1000);
    
    toast('تم إنشاء المسارات بنجاح!');
    
  } catch (error) {
    console.error('خطأ في إنشاء المسارات:', error);
    toast('حدث خطأ أثناء إنشاء المسارات');
    
    // إعادة تعيين الزر
    const runButton = document.getElementById('run');
    runButton.disabled = false;
    runButton.innerHTML = '<span><i class="fas fa-rocket"></i> توليد المسارات الحقيقية</span>';
    
    // إخفاء شريط التقدم
    document.getElementById('progressContainer').style.display = 'none';
  }
}

function distributeStudentsToBuses(students, busSizes, algorithm) {
  const busAssignments = [];
  
  // تهيئة الباصات
  for (let i = 0; i < busSizes.length; i++) {
    busAssignments.push([]);
  }
  
  if (algorithm === 'nearest') {
    // خوارزمية الأقرب أولاً الحقيقية
    const supervisorCoords = supervisorMarker.getLatLng();
    const schoolCoords = schoolMarker.getLatLng();
    
    // نسخ الطلاب لتجنب التعديل على المصفوفة الأصلية
    let remainingStudents = [...students];
    
    // لكل باص، نبدأ من موقع المشرف ونختار الأقرب ثم الأقرب منه وهكذا
    for (let busIndex = 0; busIndex < busSizes.length; busIndex++) {
      const busCapacity = busSizes[busIndex];
      let currentLocation = [supervisorCoords.lat, supervisorCoords.lng];
      let busStudents = [];
      
      while (busStudents.length < busCapacity && remainingStudents.length > 0) {
        // إيجاد أقرب طالب للموقع الحالي
        let nearestStudentIndex = -1;
        let minDistance = Infinity;
        
        for (let i = 0; i < remainingStudents.length; i++) {
          const student = remainingStudents[i];
          const distance = calculateDistance(
            currentLocation[0], currentLocation[1],
            student.lat, student.lng
          );
          
          if (distance < minDistance) {
            minDistance = distance;
            nearestStudentIndex = i;
          }
        }
        
        // إضافة أقرب طالب إلى الباص
        if (nearestStudentIndex !== -1) {
          const nearestStudent = remainingStudents[nearestStudentIndex];
          busStudents.push(nearestStudent);
          currentLocation = [nearestStudent.lat, nearestStudent.lng];
          remainingStudents.splice(nearestStudentIndex, 1);
        }
      }
      
      busAssignments[busIndex] = busStudents;
    }
    
    // إذا بقي طلاب، نوزعهم على الباصات التي بها مساحة
    if (remainingStudents.length > 0) {
      let busIndex = 0;
      remainingStudents.forEach(student => {
        while (busAssignments[busIndex].length >= busSizes[busIndex]) {
          busIndex = (busIndex + 1) % busSizes.length;
        }
        busAssignments[busIndex].push(student);
        busIndex = (busIndex + 1) % busSizes.length;
      });
    }
  } else if (algorithm === 'kmeans') {
    // تحسين خوارزمية K-means باستخدام التجمعات الجغرافية الحقيقية
    // تحديد مراكز أولية بناءً على مواقع الباصات
    const supervisorCoords = supervisorMarker.getLatLng();
    const schoolCoords = schoolMarker.getLatLng();
    
    // إنشاء مراكز أولية موزعة جغرافياً
    const centers = [];
    for (let i = 0; i < busSizes.length; i++) {
      // توزيع المراكز بين موقع المشرف والمدرسة
      const ratio = i / Math.max(1, busSizes.length - 1);
      const centerLat = supervisorCoords.lat + (schoolCoords.lat - supervisorCoords.lat) * ratio;
      const centerLng = supervisorCoords.lng + (schoolCoords.lng - supervisorCoords.lng) * ratio;
      centers.push({ lat: centerLat, lng: centerLng, students: [] });
    }
    
    // تكرار K-means مبسط
    for (let iter = 0; iter < 10; iter++) {
      // مسح الطلاب من المراكز
      centers.forEach(center => center.students = []);
      
      // تعيين كل طالب لأقرب مركز
      students.forEach(student => {
        let minDistance = Infinity;
        let nearestCenterIndex = -1;
        
        centers.forEach((center, index) => {
          const distance = calculateDistance(
            student.lat, student.lng,
            center.lat, center.lng
          );
          
          if (distance < minDistance) {
            minDistance = distance;
            nearestCenterIndex = index;
          }
        });
        
        if (nearestCenterIndex !== -1) {
          centers[nearestCenterIndex].students.push(student);
        }
      });
      
      // تحديث مراكز التجمعات
      let centersMoved = false;
      centers.forEach(center => {
        if (center.students.length > 0) {
          const avgLat = center.students.reduce((sum, student) => sum + student.lat, 0) / center.students.length;
          const avgLng = center.students.reduce((sum, student) => sum + student.lng, 0) / center.students.length;
          
          if (Math.abs(center.lat - avgLat) > 0.001 || Math.abs(center.lng - avgLng) > 0.001) {
            centersMoved = true;
            center.lat = avgLat;
            center.lng = avgLng;
          }
        }
      });
      
      // إذا لم تتحرك المراكز كثيراً، نتوقف
      if (!centersMoved) break;
    }
    
    // توزيع الطلاب على الباصات مع مراعاة السعة
    let allAssignedStudents = [];
    centers.forEach(center => {
      allAssignedStudents = allAssignedStudents.concat(center.students);
    });
    
    // التأكد من أن جميع الطلاب قد تم تعيينهم
    if (allAssignedStudents.length < students.length) {
      const assignedIds = new Set(allAssignedStudents.map(s => `${s.lat},${s.lng}`));
      students.forEach(student => {
        const studentId = `${student.lat},${student.lng}`;
        if (!assignedIds.has(studentId)) {
          allAssignedStudents.push(student);
        }
      });
    }
    
    // توزيع الطلاب على الباصات مع مراعاة السعة
    let studentIndex = 0;
    for (let busIndex = 0; busIndex < busSizes.length; busIndex++) {
      const busCapacity = busSizes[busIndex];
      while (busAssignments[busIndex].length < busCapacity && studentIndex < allAssignedStudents.length) {
        busAssignments[busIndex].push(allAssignedStudents[studentIndex]);
        studentIndex++;
      }
    }
  } else {
    // التوزيع المتوازن مع مراعاة القرب الجغرافي
    // نسخ الطلاب وفرزهم حسب القرب من خط الوسط بين المشرف والمدرسة
    const supervisorCoords = supervisorMarker.getLatLng();
    const schoolCoords = schoolMarker.getLatLng();
    const midLat = (supervisorCoords.lat + schoolCoords.lat) / 2;
    const midLng = (supervisorCoords.lng + schoolCoords.lng) / 2;
    
    const sortedStudents = [...students].sort((a, b) => {
      const distA = calculateDistance(a.lat, a.lng, midLat, midLng);
      const distB = calculateDistance(b.lat, b.lng, midLat, midLng);
      return distA - distB;
    });
    
    let busIndex = 0;
    sortedStudents.forEach(student => {
      // البحث عن باص به مساحة
      while (busAssignments[busIndex].length >= busSizes[busIndex]) {
        busIndex = (busIndex + 1) % busSizes.length;
      }
      
      busAssignments[busIndex].push(student);
      busIndex = (busIndex + 1) % busSizes.length;
    });
  }
  
  return busAssignments;
}

async function createRouteForBus(busStudents, routeType, busIndex) {
  try {
    // تحديد نقاط البداية والنهاية بناءً على نوع المسار
    const supervisorCoords = supervisorMarker.getLatLng();
    const schoolCoords = schoolMarker.getLatLng();
    
    let waypoints = [];
    
    // تحسين ترتيب الطلاب بناءً على القرب الجغرافي
    if (busStudents.length > 0) {
      let currentLocation = routeType === 'morning' 
        ? [supervisorCoords.lat, supervisorCoords.lng] 
        : [schoolCoords.lat, schoolCoords.lng];
      
      let remainingStudents = [...busStudents];
      let orderedStudents = [];
      
      // خوارزمية أقرب جار (Nearest Neighbor) لترتيب الطلاب
      while (remainingStudents.length > 0) {
        let nearestStudentIndex = -1;
        let minDistance = Infinity;
        
        for (let i = 0; i < remainingStudents.length; i++) {
          const student = remainingStudents[i];
          const distance = calculateDistance(
            currentLocation[0], currentLocation[1],
            student.lat, student.lng
          );
          
          if (distance < minDistance) {
            minDistance = distance;
            nearestStudentIndex = i;
          }
        }
        
        if (nearestStudentIndex !== -1) {
          const nearestStudent = remainingStudents[nearestStudentIndex];
          orderedStudents.push(nearestStudent);
          currentLocation = [nearestStudent.lat, nearestStudent.lng];
          remainingStudents.splice(nearestStudentIndex, 1);
        }
      }
      
      // استخدام الترتيب المحسن للطلاب
      orderedStudents.forEach(student => {
        waypoints.push([student.lat, student.lng]);
      });
    }
    
    // تحديد ترتيب النقاط بناءً على نوع المسار
    let coordinates = [];
    
    if (routeType === 'morning') {
      // مسار الصباح: المشرف -> الطلاب (مرتبين) -> المدرسة
      coordinates = [
        [supervisorCoords.lat, supervisorCoords.lng],
        ...waypoints,
        [schoolCoords.lat, schoolCoords.lng]
      ];
    } else {
      // مسار المساء: المدرسة -> الطلاب (مرتبين) -> المشرف
      coordinates = [
        [schoolCoords.lat, schoolCoords.lng],
        ...waypoints,
        [supervisorCoords.lat, supervisorCoords.lng]
      ];
    }
    
    // استدعاء خدمة OSRM للحصول على المسار
    const route = await getRouteFromOSRM(coordinates);
    
    if (route) {
      return {
        type: routeType,
        busIndex: busIndex,
        coordinates: coordinates,
        route: route,
        students: busStudents,
        orderedStudents: waypoints.map(wp => {
          // إيجاد الطالب المقابل للإحداثيات
          return busStudents.find(s => s.lat === wp[0] && s.lng === wp[1]);
        }).filter(s => s) // إزالة القيم غير المعرفة
      };
    }
    
    return null;
  } catch (error) {
    console.error(`خطأ في إنشاء مسار الباص ${busIndex} (${routeType}):`, error);
    return null;
  }
}

async function getRouteFromOSRM(coordinates) {
  try {
    // تحويل الإحداثيات إلى تنسيق OSRM (خط الطول أولاً، ثم خط العرض)
    const coordsString = coordinates.map(coord => `${coord[1]},${coord[0]}`).join(';');
    
    // استدعاء خدمة OSRM
    const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordsString}?overview=full&geometries=geojson`);
    
    if (!response.ok) {
      throw new Error(`خطأ في استدعاء OSRM: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.routes && data.routes.length > 0) {
      return data.routes[0];
    } else {
      throw new Error('لم يتم العثور على مسار');
    }
  } catch (error) {
    console.error('خطأ في الحصول على المسار من OSRM:', error);
    
    // في حالة الفشل، نعيد مساراً مباشراً بين النقاط
    return {
      geometry: {
        coordinates: coordinates.map(coord => [coord[1], coord[0]])
      },
      distance: 0,
      duration: 0
    };
  }
}

function displayRoutes(routes) {
  // مسح المسارات القديمة
  clearRoutes();
  
  // ألوان مختلفة لكل باص
  const busColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4'];
  
  routes.forEach(routeData => {
    const color = busColors[routeData.busIndex % busColors.length];
    
    // رسم المسار على الخريطة
    if (routeData.route && routeData.route.geometry) {
      const routeLayer = L.geoJSON(routeData.route.geometry, {
        style: {
          color: color,
          weight: 6,
          opacity: 0.8
        }
      }).addTo(map);
      
      routeLayers.push(routeLayer);
      
      // إضافة علامات للنقاط الرئيسية
      addRouteMarkers(routeData, color);
    }
  });
  
  // تحديث قائمة الطلاب حسب المسارات
  updateStudentsByRoute(routes);
  
  // تحديث روابط المسارات
  updateRouteLinks(routes);
  
  // حفظ المسارات الأخيرة
  lastRoutes = routes;
}

function addRouteMarkers(routeData, color) {
  const { type, busIndex, coordinates, students } = routeData;
  
  // إضافة علامة البداية
  const startCoord = coordinates[0];
  const startMarker = L.marker([startCoord[0], startCoord[1]], {
    icon: L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: ${color}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${type === 'morning' ? 'م' : 'ص'}</div>`,
      iconSize: [30, 30]
    })
  }).addTo(map);
  
  routeLayers.push(startMarker);
  
  // إضافة علامة النهاية
  const endCoord = coordinates[coordinates.length - 1];
  const endMarker = L.marker([endCoord[0], endCoord[1]], {
    icon: L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: ${color}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${type === 'morning' ? 'ن' : 'م'}</div>`,
      iconSize: [30, 30]
    })
  }).addTo(map);
  
  routeLayers.push(endMarker);
  
  // إضافة علامات للطلاب في هذا المسار
  students.forEach((student, index) => {
    const studentMarker = L.marker([student.lat, student.lng], {
      icon: L.divIcon({
        className: 'custom-marker',
        html: `<div style="background: ${color}; color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${index + 1}</div>`,
        iconSize: [26, 26]
      })
    }).addTo(map);
    
    routeLayers.push(studentMarker);
  });
}

function clearRoutes() {
  // إزالة جميع الطبقات المرتبطة بالمسارات
  routeLayers.forEach(layer => {
    map.removeLayer(layer);
  });
  
  routeLayers = [];
  busAnimations = [];
  
  // إيقاف جميع الفواصل الزمنية للرسوم المتحركة
  animationIntervals.forEach(interval => {
    clearInterval(interval);
  });
  
  animationIntervals = [];
  isAnimating = false;
}

// ==================== وظائف مساعدة ====================
function toggleCard(cardHeader) {
  const cardContent = cardHeader.nextElementSibling;
  const icon = cardHeader.querySelector('.fa-chevron-down');
  
  if (cardContent.style.display === 'none' || !cardContent.style.display) {
    cardContent.style.display = 'block';
    icon.className = 'fas fa-chevron-up';
  } else {
    cardContent.style.display = 'none';
    icon.className = 'fas fa-chevron-down';
  }
}

function toast(message) {
  const toastEl = document.getElementById('toast');
  toastEl.textContent = message;
  toastEl.style.display = 'block';
  
  setTimeout(() => {
    toastEl.style.display = 'none';
  }, 3000);
}

function loadInitialData() {
  // تعيين النوع الافتراضي للمسار
  window.selectedRouteType = 'both';
  
  // تحديث قائمة الطلاب
  updateStudentsList();
  
  // طي جميع البطاقات في البداية
  document.querySelectorAll('.card-content').forEach(content => {
    content.style.display = 'none';
  });
  
  // فتح البطاقات المهمة فقط
  document.querySelectorAll('.card-header')[0].click(); // إعدادات الذكاء الاصطناعي
  document.querySelectorAll('.card-header')[2].click(); // المدرسة والمشرف
  document.querySelectorAll('.card-header')[3].click(); // الطلاب
}

function bindEvents() {
  // الأحداث الجديدة للذكاء الاصطناعي
  document.getElementById('testAi').addEventListener('click', testAIConnection);
  document.getElementById('runWithAI').addEventListener('click', generateRoutesWithAI);
  document.getElementById('aiModel').addEventListener('change', function() {
    aiModel = this.value;
  });
  
  // أحداث التحكم بالرسوم المتحركة
  document.getElementById('playAnimation').addEventListener('click', startAnimation);
  document.getElementById('pauseAnimation').addEventListener('click', pauseAnimation);
  document.getElementById('resetAnimation').addEventListener('click', resetAnimation);
  
  // حدث تبديل الوضع
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  
  // حدث فتح محول الإحداثيات
  document.getElementById('openConverterBtn').addEventListener('click', openCoordinateConverter);
  
  // الأحداث الحالية...
  document.getElementById('setMarkersBtn').addEventListener('click', setMarkersFromInput);
  document.getElementById('useMapBtn').addEventListener('click', useMapMarkers);
  document.getElementById('addStudent').addEventListener('click', addStudent);
  document.getElementById('clearStudents').addEventListener('click', clearStudents);
  document.getElementById('addBulk').addEventListener('click', addBulkStudents);
  
  document.querySelectorAll('.route-type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.route-type-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      window.selectedRouteType = this.getAttribute('data-type');
    });
  });
  
  document.getElementById('run').addEventListener('click', generateRoutes);
  document.getElementById('exportCsv').addEventListener('click', exportToCsv);
  document.getElementById('exportXlsx').addEventListener('click', exportToExcel);
  document.getElementById('savePlan').addEventListener('click', savePlan);
  document.getElementById('loadPlanInput').addEventListener('change', loadPlan);
}

function toggleApiKeyVisibility() {
  const apiKeyInput = document.getElementById('apiKey');
  const toggleBtn = document.querySelector('.toggle-visibility i');
  
  if (apiKeyInput.type === 'password') {
    apiKeyInput.type = 'text';
    toggleBtn.className = 'fas fa-eye-slash';
  } else {
    apiKeyInput.type = 'password';
    toggleBtn.className = 'fas fa-eye';
  }
}

function testAIConnection() {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) {
    alert('الرجاء إدخال مفتاح OpenAI API');
    return;
  }
  
  // حفظ المفتاح في المتغير
  openAIApiKey = apiKey;
  
  // اختبار الاتصال مع OpenAI
  fetch('https://api.openai.com/v1/models', {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${openAIApiKey}`
    }
  })
  .then(response => {
    if (response.ok) {
      toast('الاتصال ناجح! يمكنك استخدام الذكاء الاصطناعي الآن.');
      isAIEnabled = true;
    } else {
      toast('فشل الاتصال. تأكد من صحة المفتاح.');
      isAIEnabled = false;
    }
  })
  .catch(error => {
    console.error('خطأ في الاتصال:', error);
    toast('حدث خطأ في الاتصال. تأكد من اتصال الإنترنت.');
    isAIEnabled = false;
  });
}

async function generateRoutesWithAI() {
  if (!isAIEnabled) {
    alert('الرجاء تفعيل الذكاء الاصطناعي أولاً عن طريق اختبار الاتصال.');
    return;
  }
  
  toast('جاري توليد المسارات بالذكاء الاصطناعي...');
  
  try {
    // إعداد البيانات للإرسال إلى OpenAI
    const prompt = `
    لدينا نظام مسارات باصات مدرسية مع البيانات التالية:
    - المدرسة: ${document.getElementById('school').value}
    - المشرف: ${document.getElementById('supervisor').value}
    - عدد الطلاب: ${students.length}
    - سعات الباصات: ${document.getElementById('busSizes').value}
    - نوع المسار: ${window.selectedRouteType}
    
    الطلاب:
    ${students.map((student, index) => `${index + 1}. ${student.name}: ${student.lat}, ${student.lng}`).join('\n')}
    
    يرجى اقتراح تحسينات على توزيع الطلاب على الباصات وتحسين المسارات لتحقيق:
    1. تقليل وقت الرحلة
    2. تقليل المسافة المقطوعة
    3. توزيع متوازن للطلاب على الباصات
    4. تجنب الازدحام المروري
    
    قدم اقتراحات محددة لتحسين النظام.
    `;
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${openAIApiKey}`
      },
      body: JSON.stringify({
        model: aiModel,
        messages: [
          {
            role: 'system',
            content: 'أنت مساعد متخصص في تحسين مسارات الباصات المدرسية. قدم اقتراحات عملية ومحددة.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        max_tokens: 1000
      })
    });
    
    if (!response.ok) {
      throw new Error('فشل في الاتصال بـ OpenAI API');
    }
    
    const data = await response.json();
    const aiSuggestions = data.choices[0].message.content;
    
    // عرض اقتراحات الذكاء الاصطناعي
    const aiSuggestionsEl = document.getElementById('aiSuggestions');
    aiSuggestionsEl.innerHTML = `
      <h4><i class="fas fa-robot"></i> اقتراحات الذكاء الاصطناعي</h4>
      <p>${aiSuggestions.replace(/\n/g, '<br>')}</p>
    `;
    aiSuggestionsEl.style.display = 'block';
    
    // توليد المسارات العادية مع الأخذ بالاعتبار اقتراحات الذكاء الاصطناعي
    generateRoutes();
    
  } catch (error) {
    console.error('خطأ في استخدام الذكاء الاصطناعي:', error);
    toast('حدث خطأ في استخدام الذكاء الاصطناعي. استخدم المسارات العادية.');
    generateRoutes();
  }
}

function exportToCsv() {
  if (lastRoutes.length === 0) {
    alert('لا توجد مسارات لتصديرها. يرجى إنشاء المسارات أولاً.');
    return;
  }
  
  try {
    let csvContent = "الرقم,اسم الطالب,موقع الطالب,نوع المسار,رقم الباص\n";
    
    let studentNumber = 1;
    lastRoutes.forEach(route => {
      route.students.forEach((student) => {
        csvContent += `${studentNumber},"${student.name}","${student.lat.toFixed(6)}, ${student.lng.toFixed(6)}",${route.type},${route.busIndex + 1}\n`;
        studentNumber++;
      });
    });
    
    // إنشاء ملف CSV وتنزيله
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'مسارات_الباصات.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    toast('تم تصدير البيانات بصيغة CSV بنجاح!');
  } catch (error) {
    console.error('خطأ في تصدير CSV:', error);
    toast('حدث خطأ أثناء تصدير البيانات');
  }
}

function exportToExcel() {
  if (lastRoutes.length === 0) {
    alert('لا توجد مسارات لتصديرها. يرجى إنشاء المسارات أولاً.');
    return;
  }
  
  try {
    // إعداد البيانات لملف Excel
    const data = [];
    
    // إضافة رأس الجدول
    data.push(['الرقم', 'اسم الطالب', 'موقع الطالب', 'نوع المسار', 'رقم الباص']);
    
    // إضافة بيانات المسارات
    let studentNumber = 1;
    lastRoutes.forEach(route => {
      route.students.forEach((student) => {
        data.push([
          studentNumber,
          student.name,
          `${student.lat.toFixed(6)}, ${student.lng.toFixed(6)}`,
          route.type,
          route.busIndex + 1
        ]);
        studentNumber++;
      });
    });
    
    // إنشاء مصنف Excel
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'مسارات الباصات');
    
    // تصدير الملف
    XLSX.writeFile(wb, 'مسارات_الباصات.xlsx');
    
    toast('تم تصدير البيانات بصيغة Excel بنجاح!');
  } catch (error) {
    console.error('خطأ في تصدير Excel:', error);
    toast('حدث خطأ أثناء تصدير البيانات');
  }
}

function savePlan() {
  const plan = {
    students: students,
    school: document.getElementById('school').value,
    supervisor: document.getElementById('supervisor').value,
    busSizes: document.getElementById('busSizes').value,
    algorithm: document.getElementById('algorithm').value,
    routeType: window.selectedRouteType,
    apiKey: document.getElementById('apiKey').value,
    aiModel: document.getElementById('aiModel').value
  };
  
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(plan));
  const downloadAnchorNode = document.createElement('a');
  downloadAnchorNode.setAttribute("href", dataStr);
  downloadAnchorNode.setAttribute("download", "bus_plan.json");
  document.body.appendChild(downloadAnchorNode);
  downloadAnchorNode.click();
  downloadAnchorNode.remove();
  
  toast('تم حفظ الخطة بنجاح!');
}

function loadPlan(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const plan = JSON.parse(e.target.result);
      
      // تحميل البيانات
      students = plan.students || [];
      document.getElementById('school').value = plan.school || '';
      document.getElementById('supervisor').value = plan.supervisor || '';
      document.getElementById('busSizes').value = plan.busSizes || '';
      document.getElementById('algorithm').value = plan.algorithm || 'kmeans';
      document.getElementById('apiKey').value = plan.apiKey || '';
      document.getElementById('aiModel').value = plan.aiModel || 'gpt-3.5-turbo';
      
      // تحديث النوع المختار للمسار
      window.selectedRouteType = plan.routeType || 'both';
      document.querySelectorAll('.route-type-btn').forEach(btn => {
        if (btn.getAttribute('data-type') === window.selectedRouteType) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      // تحديث العلامات والقوائم
      renderStudentMarkers();
      updateStudentsList();
      
      // تحديث مواقع المدرسة والمشرف
      setMarkersFromInput();
      
      toast('تم تحميل الخطة بنجاح!');
    } catch (error) {
      console.error('خطأ في تحميل الخطة:', error);
      alert('خطأ في تحميل الملف. تأكد من صحة تنسيق الملف.');
    }
  };
  
  reader.readAsText(file);
  
  // إعادة تعيين حقل الملف
  event.target.value = '';
}

function toggleTheme() {
  document.body.classList.toggle('light-mode');
  const icon = document.getElementById('themeIcon');
  if (document.body.classList.contains('light-mode')) {
    icon.className = 'fas fa-sun';
    toast('تم تفعيل الوضع الفاتح');
  } else {
    icon.className = 'fas fa-moon';
    toast('تم تفعيل الوضع الداكن');
  }
}

// ==================== وظائف الرسوم المتحركة ====================
function startAnimation() {
  if (isAnimating) return;
  
  isAnimating = true;
  busAnimations = [];
  
  // إخفاء علامات الطلاب أثناء الحركة
  studentMarkers.forEach(marker => {
    marker.setOpacity(0.3);
  });
  
  // إنشاء حركة لكل مسار
  lastRoutes.forEach(route => {
    if (route.route && route.route.geometry && route.route.geometry.coordinates) {
      const busAnimation = createBusAnimation(route);
      busAnimations.push(busAnimation);
    }
  });
  
  toast('بدأت حركة الباصات');
}

function createBusAnimation(route) {
  const coordinates = route.route.geometry.coordinates;
  const color = getBusColor(route.busIndex);
  let currentIndex = 0;
  
  // إنشاء علامة الباص المتحركة
  const busMarker = L.marker([coordinates[0][1], coordinates[0][0]], {
    icon: L.divIcon({
      className: 'bus-marker',
      html: `<div style="background: ${color};"><i class="fas fa-bus bus-icon"></i></div>`,
      iconSize: [24, 24]
    })
  }).addTo(map);
  
  // إضافة الباص إلى الطبقات المرتبطة بالمسار
  routeLayers.push(busMarker);
  
  // حركة الباص على المسار
  const interval = setInterval(() => {
    if (!isAnimating) {
      clearInterval(interval);
      return;
    }
    
    if (currentIndex < coordinates.length - 1) {
      currentIndex++;
      const newCoord = coordinates[currentIndex];
      busMarker.setLatLng([newCoord[1], newCoord[0]]);
    } else {
      // إعادة الباص إلى البداية عند الوصول إلى النهاية
      currentIndex = 0;
      const newCoord = coordinates[currentIndex];
      busMarker.setLatLng([newCoord[1], newCoord[0]]);
    }
  }, 100); // تحديث كل 100 مللي ثانية
  
  animationIntervals.push(interval);
  
  return {
    marker: busMarker,
    interval: interval
  };
}

function pauseAnimation() {
  isAnimating = false;
  
  // إيقاف جميع الفواصل الزمنية
  animationIntervals.forEach(interval => {
    clearInterval(interval);
  });
  
  animationIntervals = [];
  
  // إعادة عرض علامات الطلاب
  studentMarkers.forEach(marker => {
    marker.setOpacity(1);
  });
  
  toast('تم إيقاف الحركة مؤقتاً');
}

function resetAnimation() {
  pauseAnimation();
  
  // إزالة علامات الباص المتحركة
  busAnimations.forEach(animation => {
    if (animation.marker) {
      map.removeLayer(animation.marker);
    }
  });
  
  busAnimations = [];
  
  toast('تم إعادة تعيين الحركة');
}

function getBusColor(busIndex) {
  const busColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4'];
  return busColors[busIndex % busColors.length];
}

// ==================== وظائف إضافية للطلاب حسب المسارات ====================
function updateStudentsByRoute(routes) {
  const container = document.getElementById('studentsByRoute');
  container.innerHTML = '';
  
  if (routes.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">لا توجد مسارات معروضة</div>';
    return;
  }
  
  routes.forEach(route => {
    const routeElement = document.createElement('div');
    routeElement.className = 'route-section';
    
    const routeTitle = document.createElement('div');
    routeTitle.style.cssText = 'font-weight: bold; margin-bottom: 8px; padding: 8px; background: var(--light); border-radius: 8px;';
    routeTitle.innerHTML = `
      <i class="fas fa-bus" style="color: ${getBusColor(route.busIndex)};"></i>
      الباص ${route.busIndex + 1} - ${route.type === 'morning' ? 'مسار صباحي' : 'مسار مسائي'}
      <span style="float: left; font-size: 12px; font-weight: normal;">
        ${route.route ? (route.route.distance / 1000).toFixed(1) + ' كم' : 'غير معروف'}
      </span>
    `;
    
    routeElement.appendChild(routeTitle);
    
    const studentList = document.createElement('div');
    studentList.className = 'student-list-route';
    
    // استخدام الترتيب المحسن إن وجد
    const displayStudents = route.orderedStudents && route.orderedStudents.length > 0 
      ? route.orderedStudents 
      : route.students;
    
    displayStudents.forEach((student, index) => {
      const studentItem = document.createElement('div');
      studentItem.className = 'student-route-item';
      
      // حساب المسافة من النقطة السابقة (تقريبي)
      let distanceInfo = '';
      if (index > 0 && route.coordinates) {
        const prevStudent = displayStudents[index - 1];
        const distance = calculateDistance(
          prevStudent.lat, prevStudent.lng,
          student.lat, student.lng
        );
        distanceInfo = `<div style="font-size: 10px; color: var(--muted);">${distance.toFixed(1)} كم من المحطة السابقة</div>`;
      } else if (index === 0) {
        const startPoint = route.type === 'morning' 
          ? supervisorMarker.getLatLng() 
          : schoolMarker.getLatLng();
        const distance = calculateDistance(
          startPoint.lat, startPoint.lng,
          student.lat, student.lng
        );
        distanceInfo = `<div style="font-size: 10px; color: var(--muted);">${distance.toFixed(1)} كم من نقطة البداية</div>`;
      }
      
      studentItem.innerHTML = `
        <div class="student-number">${index + 1}</div>
        <div class="student-info">
          <div class="student-name-route">${student.name}</div>
          <div class="student-location">${student.lat.toFixed(4)}, ${student.lng.toFixed(4)}</div>
          ${distanceInfo}
        </div>
      `;
      
      studentList.appendChild(studentItem);
    });
    
    routeElement.appendChild(studentList);
    container.appendChild(routeElement);
  });
}

function updateRouteLinks(routes) {
  const container = document.getElementById('routeLinks');
  container.innerHTML = '';
  
  if (routes.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">لا توجد مسارات معروضة</div>';
    return;
  }
  
  routes.forEach(route => {
    const routeLink = document.createElement('div');
    routeLink.className = 'route-link';
    
    // إنشاء رابط خرائط جوجل للمسار
    const googleMapsUrl = generateGoogleMapsUrl(route);
    const waypointCount = route.coordinates.length;
    
    routeLink.innerHTML = `
      <div class="route-link-title">
        <i class="fas fa-bus" style="color: ${getBusColor(route.busIndex)};"></i>
        الباص ${route.busIndex + 1} - ${route.type === 'morning' ? 'مسار صباحي' : 'مسار مسائي'}
      </div>
      <div class="route-link-details">
        <span>${route.students.length} طالب</span>
        <span>${route.route ? (route.route.distance / 1000).toFixed(1) + ' كم' : 'غير معروف'}</span>
      </div>
      <div class="route-link-info">
        <i class="fas fa-map-marker-alt"></i> ${waypointCount} نقطة في المسار
        ${waypointCount > 40 ? '<span class="warning-text"> (تم اختصار النقاط لتناسب خرائط جوجل)</span>' : ''}
      </div>
      <a href="${googleMapsUrl}" target="_blank" class="google-maps-link">
        <i class="fas fa-external-link-alt"></i> فتح في خرائط جوجل
      </a>
      <button onclick="copyGoogleMapsLink('${googleMapsUrl}')" class="btn-outline" style="padding: 6px 10px; font-size: 12px; width: 100%; margin-top: 6px;">
        <i class="fas fa-copy"></i> نسخ الرابط
      </button>
    `;
    
    container.appendChild(routeLink);
  });
}

// ==================== وظيفة إنشاء رابط خرائط جوجل ====================
function generateGoogleMapsUrl(route) {
  // جميع نقاط المسار: البداية، الطلاب (مرتبين)، النهاية
  const waypoints = route.coordinates.map(coord => `${coord[0]},${coord[1]}`);
  
  // إذا كان عدد النقاط أكثر من 40، نأخذ النقاط الرئيسية فقط لتجنب تجاوز الحد
  let waypointsForUrl = waypoints;
  if (waypoints.length > 40) {
    // نأخذ 40 نقطة بشكل متساوي من المسار
    waypointsForUrl = [];
    const step = Math.floor(waypoints.length / 40);
    for (let i = 0; i < waypoints.length && waypointsForUrl.length < 40; i += step) {
      waypointsForUrl.push(waypoints[i]);
    }
    // نتأكد من إضافة نقطة البداية والنهاية
    if (!waypointsForUrl.includes(waypoints[0])) {
      waypointsForUrl.unshift(waypoints[0]);
    }
    if (!waypointsForUrl.includes(waypoints[waypoints.length - 1])) {
      waypointsForUrl.push(waypoints[waypoints.length - 1]);
    }
    // نحافظ على 40 نقطة كحد أقصى
    waypointsForUrl = waypointsForUrl.slice(0, 40);
  }
  
  const origin = waypointsForUrl[0];
  const destination = waypointsForUrl[waypointsForUrl.length - 1];
  const waypointsStr = waypointsForUrl.slice(1, -1).join('|');
  
  let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
  
  // إضافة نقاط الطريق إذا كانت موجودة
  if (waypointsStr) {
    url += `&waypoints=${waypointsStr}`;
  }
  
  return url;
}

// ==================== وظيفة نسخ رابط خرائط جوجل ====================
function copyGoogleMapsLink(url) {
  navigator.clipboard.writeText(url).then(function() {
    toast('تم نسخ رابط خرائط جوجل إلى الحافظة');
  }, function(err) {
    console.error('فشل في نسخ الرابط: ', err);
    // طريقة بديلة للمتصفحات القديمة
    const textArea = document.createElement("textarea");
    textArea.value = url;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand("copy");
    document.body.removeChild(textArea);
    toast('تم نسخ رابط خرائط جوجل إلى الحافظة');
  });
}
</script>
</body>
</html>